---
phase: 02-session-state-research-journal
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - commands/init.md
  - commands/status.md
  - commands/problem.md
  - commands/notation.md
  - commands/switch.md
  - commands/archive.md
  - agents/math-intake.md
autonomous: true

must_haves:
  truths:
    - "/math:init creates per-problem directory structure under .math/problems/{slug}/ with PROBLEM.md, NOTATION.md, STATE.md, JOURNAL.md and registers the problem in config.json"
    - "/math:switch lists active problems with current marker and switches the active problem pointer in config.json"
    - "/math:archive moves a completed problem from problems/ to archive/ and updates config.json"
    - "All Phase 1 commands (status, problem, notation) resolve file paths through config.json current_problem pointer instead of .math/ root"
    - "Backward compatibility: if files exist at .math/ root (Phase 1 layout), auto-migrate to per-problem directory on first access"
  artifacts:
    - path: "commands/init.md"
      provides: "Multi-problem /math:init with per-problem directory creation"
      contains: "problems/"
    - path: "commands/switch.md"
      provides: "/math:switch command for workspace switching"
      contains: "current_problem"
    - path: "commands/archive.md"
      provides: "/math:archive command for problem completion"
      contains: "archive/"
    - path: "commands/status.md"
      provides: "Updated /math:status with path resolution through config.json"
      contains: "current_problem"
    - path: "commands/problem.md"
      provides: "Updated /math:problem with path resolution through config.json"
      contains: "current_problem"
    - path: "commands/notation.md"
      provides: "Updated /math:notation with path resolution through config.json"
      contains: "current_problem"
    - path: "agents/math-intake.md"
      provides: "Updated intake agent writing to per-problem directory"
      contains: "problems/"
  key_links:
    - from: "commands/init.md"
      to: "templates/config.json"
      via: "Init creates config.json from updated template with problems array"
      pattern: "config\\.json"
    - from: "commands/switch.md"
      to: "commands/resume.md"
      via: "Switch auto-triggers resume flow after switching"
      pattern: "resume"
    - from: "commands/init.md"
      to: "templates/JOURNAL.md"
      via: "Init creates JOURNAL.md in per-problem directory from template"
      pattern: "JOURNAL\\.md"
---

<objective>
Update /math:init for multi-problem directory structure, create /math:switch and /math:archive commands, and update all Phase 1 commands to resolve paths through config.json current_problem pointer with backward compatibility migration.

Purpose: This plan makes the plugin multi-problem-aware. After this, each problem gets its own isolated directory with all artifacts, users can switch between problems, and archive completed work. All existing commands continue to work seamlessly.
Output: 2 new commands (switch, archive), 5 updated commands/agents (init, status, problem, notation, math-intake)
</objective>

<execution_context>
@/Users/matteo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matteo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-state-research-journal/02-CONTEXT.md
@.planning/phases/02-session-state-research-journal/02-RESEARCH.md

# Phase 1 commands being updated (read all before modifying):
@commands/init.md
@commands/status.md
@commands/problem.md
@commands/notation.md
@agents/math-intake.md

# Phase 2 Plan 01 outputs (templates and protocol this plan depends on):
@.planning/phases/02-session-state-research-journal/02-01-SUMMARY.md
@templates/config.json
@templates/JOURNAL.md
@templates/DASHBOARD.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /math:init for multi-problem support and update Phase 1 commands for path resolution</name>
  <files>
    commands/init.md
    commands/status.md
    commands/problem.md
    commands/notation.md
    agents/math-intake.md
  </files>
  <action>
**Path Resolution Pattern** -- All commands updated in this task share a common path resolution pattern. Document this at the top of each command or inline where file paths are constructed:

```
Path Resolution:
1. Read .math/config.json
2. Get current_problem slug
3. Resolve paths as .math/problems/{current_problem}/FILENAME.md
4. If config.json has no current_problem OR .math/config.json doesn't exist but .math/PROBLEM.md does (Phase 1 layout):
   → Auto-migrate: create problems/{slug}/ directory, move PROBLEM.md, NOTATION.md, STATE.md into it, update config.json
```

**commands/init.md** -- Major update. Rewrite the init command to support multi-problem directories:

Step 1 (Check existing): Same as Phase 1 but check `.math/config.json` instead of just `.math/` directory. If `.math/` exists with a Phase 1 flat layout (PROBLEM.md at root), inform user: "Detected Phase 1 project layout. This will be upgraded to multi-problem format."

Step 2 (Select domain): Same as Phase 1 -- present 10 domain options, wait for selection.

Step 3 (Create structure): This is the key change.

If `.math/` does NOT exist (fresh project):
1. Create `.math/` directory
2. Create `.math/config.json` from updated template (version 0.2.0, empty problems array, empty archived array, no current_problem)
3. Create `.math/problems/` directory
4. Create `.math/archive/` directory
5. Generate problem slug: ask user for a short title or generate from domain + "problem-1". Slugify: lowercase, replace spaces with hyphens, first 3-4 keywords, check uniqueness against config.json problems array.
6. Create `.math/problems/{slug}/` directory
7. Copy templates into the problem directory:
   - `.math/problems/{slug}/PROBLEM.md` from `templates/PROBLEM.md`
   - `.math/problems/{slug}/NOTATION.md` from `templates/NOTATION.md` (merged with preset, same as Phase 1)
   - `.math/problems/{slug}/STATE.md` from `templates/STATE.md`
   - `.math/problems/{slug}/JOURNAL.md` from `templates/JOURNAL.md` (NEW -- fill `problem` frontmatter field with slug)
8. Update `.math/config.json`: set `current_problem` to slug, add problem entry to `problems` array with slug, title, domain, notation_preset, created timestamp, last_active timestamp, state "INITIALIZED"

If `.math/` exists with Phase 1 layout (backward compatibility migration):
1. Read existing `.math/config.json` to get domain
2. Read `.math/PROBLEM.md` frontmatter to derive a slug from problem title (or use domain + "-problem" as fallback)
3. Create `.math/problems/` and `.math/archive/` directories
4. Create `.math/problems/{slug}/` directory
5. Move `.math/PROBLEM.md` → `.math/problems/{slug}/PROBLEM.md`
6. Move `.math/NOTATION.md` → `.math/problems/{slug}/NOTATION.md`
7. Move `.math/STATE.md` → `.math/problems/{slug}/STATE.md`
8. Create `.math/problems/{slug}/JOURNAL.md` from template
9. Rewrite `.math/config.json` with Phase 2 schema, current_problem set to slug, problem entry in problems array

Step 4 (Display summary): Updated to show new structure:
```
Math research project initialized in .math/

  Problem: {slug} ({domain})
  Location: .math/problems/{slug}/
  Files: PROBLEM.md, NOTATION.md, STATE.md, JOURNAL.md

Next: Submit a problem with /math:problem
```

**commands/status.md** -- Update path resolution:
- Step 1: Same (check .math/ exists)
- Step 2: NEW -- Read `.math/config.json`, get `current_problem`. If no current_problem, show "No active problem. Run /math:init or /math:switch." Resolve all file paths as `.math/problems/{current_problem}/FILENAME.md` instead of `.math/FILENAME.md`.
- Step 3: Same dashboard format but with updated paths. Add a line showing: `Problem: {slug} ({domain})` and `Location: .math/problems/{slug}/`
- Step 4: Same contextual next steps
- Step 5: Same recent history
- Add migration check: if `.math/PROBLEM.md` exists at root (Phase 1 layout), inform user: "Detected legacy layout. Run /math:init to upgrade to multi-problem format."

**commands/problem.md** -- Update path resolution:
- Add Step 0: Read `.math/config.json`, get `current_problem`, resolve problem directory as `.math/problems/{current_problem}/`. Pass this path to the math-intake agent.
- Rest stays the same (delegates to math-intake agent via Task tool)
- Add migration check: if no current_problem in config, suggest /math:init

**commands/notation.md** -- Update path resolution:
- Read the existing notation.md command. Replace all references to `.math/NOTATION.md` with path-resolved `.math/problems/{current_problem}/NOTATION.md`.
- Add config.json reading at the start to resolve current_problem.
- Add migration check if Phase 1 layout detected.

**agents/math-intake.md** -- Update to write to per-problem directory:
- Read the existing math-intake.md agent. The agent currently writes to `.math/PROBLEM.md` and `.math/STATE.md`.
- Update all write paths to use the problem directory path passed from /math:problem command.
- The agent should receive the problem directory path as context from the calling command.
- Update STATE.md write to `.math/problems/{slug}/STATE.md`
- Update PROBLEM.md write to `.math/problems/{slug}/PROBLEM.md`
- After writing PROBLEM.md, also update `.math/config.json` problems array: set the problem's `title` field from the captured problem title, update `state` to `PROBLEM_DEFINED`, update `last_active` timestamp.
  </action>
  <verify>
For each updated file, verify:
- `grep -l "current_problem" commands/init.md commands/status.md commands/problem.md commands/notation.md` -- all 4 must match
- `grep -l "problems/" commands/init.md agents/math-intake.md` -- both must match
- `grep "config.json" commands/status.md` -- must reference config.json for path resolution
- `grep "migration\|Phase 1\|legacy\|backward" commands/init.md` -- must contain migration logic
- `grep "JOURNAL.md" commands/init.md` -- init must create JOURNAL.md in problem directory
  </verify>
  <done>
/math:init creates per-problem directories under .math/problems/{slug}/ with PROBLEM.md, NOTATION.md, STATE.md, JOURNAL.md and registers in config.json. All Phase 1 commands resolve paths through config.json current_problem. Backward compatibility migration handles Phase 1 flat layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /math:switch and /math:archive commands</name>
  <files>
    commands/switch.md
    commands/archive.md
  </files>
  <action>
**commands/switch.md** -- Create new slash command for switching between active problems. Follow the command file pattern from Phase 1 (YAML frontmatter with description and allowed-tools, markdown body with Process steps).

```yaml
---
description: Switch between active math research problems
allowed-tools:
  - Read
  - Write
---
```

Process:

Step 1: Validate project -- Check `.math/config.json` exists. If not, tell user to run `/math:init`.

Step 2: Read config.json -- Load `problems` array and `current_problem`.

Step 3: Check problem count:
- If `problems` array is empty: "No active problems. Run `/math:init` to create one."
- If only 1 problem: "Only one active problem: {slug}. No switching needed."
- If 2+ problems: proceed to Step 4.

Step 4: Display active problems as numbered list:
```
Active Problems:
  1. [*] neumann-series (analysis) -- PROOF_IN_PROGRESS -- last active: 2h ago
  2. [ ] spectral-gap (algebra) -- LITERATURE_SEARCH -- last active: 3d ago

[*] = current problem
```
Format `last_active` as relative time (e.g., "2h ago", "3d ago", "just now"). The `[*]` marker indicates the current problem.

Step 5: Wait for user to select -- User picks a number or types a slug.

Step 6: Switch -- Update `.math/config.json`:
- Set `current_problem` to selected slug
- Update selected problem's `last_active` to current ISO timestamp
- Write config.json back

Step 7: Confirm and auto-resume -- Display: "Switched to: {slug} ({domain})". Then run the resume flow: read the problem's artifacts and display a brief status summary (problem title, current state, last approach). Suggest: "Run `/math:resume` for full dashboard."

**commands/archive.md** -- Create new slash command for archiving completed problems. Follow the same YAML frontmatter pattern.

```yaml
---
description: Archive a completed math research problem
allowed-tools:
  - Read
  - Write
  - Bash
---
```

Process:

Step 1: Validate project -- Check `.math/config.json` exists.

Step 2: Determine which problem to archive:
- If user provides a slug argument, use that.
- Otherwise, show the active problems list (same as /math:switch Step 4) and ask which to archive.

Step 3: Confirm with user -- "Archive '{problem_title}' ({slug})? This moves it out of active view but keeps all files accessible in .math/archive/. (yes/no)"

Step 4: Archive -- Execute the following:
1. Create `.math/archive/` directory if it doesn't exist
2. Move `.math/problems/{slug}/` to `.math/archive/{slug}/` (using Bash: `mv`)
3. Update `.math/config.json`:
   - Remove the problem from `problems` array
   - Add to `archived` array with fields: slug, title, domain, archived (current ISO timestamp)
   - If this was `current_problem`, set `current_problem` to the next remaining active problem's slug (or empty string if none remain)
4. Add a final journal entry to the archived problem's JOURNAL.md: category NOTE, title "Problem archived", outcome SUCCEEDED, insight capturing the final state

Step 5: Confirm -- "Archived '{slug}'. {N} active problems remain." If there's a new current_problem, show it. If no active problems remain: "No active problems. Run `/math:init` to start a new one."

References section: List `.math/config.json`, `.math/problems/`, `.math/archive/`.
  </action>
  <verify>
Verify both files exist and have correct structure:
- `cat commands/switch.md` -- must have YAML frontmatter with description, must contain "current_problem" and numbered list display logic
- `cat commands/archive.md` -- must have YAML frontmatter with description, must contain "archive/" path and confirmation step
- Both files must follow the Phase 1 command pattern (YAML frontmatter + Process steps)
  </verify>
  <done>
/math:switch lists active problems with [*] current marker, relative timestamps, and switches config.json current_problem pointer with auto-resume summary. /math:archive confirms with user, moves problem directory to archive/, updates config.json (removes from problems, adds to archived), and handles current_problem reassignment.
  </done>
</task>

</tasks>

<verification>
1. /math:init creates `.math/problems/{slug}/` with PROBLEM.md, NOTATION.md, STATE.md, JOURNAL.md and populates config.json problems array
2. /math:status, /math:problem, /math:notation all resolve paths through config.json current_problem
3. Backward compatibility: migration logic exists for Phase 1 flat layout
4. /math:switch displays numbered problem list with current marker and switches active problem
5. /math:archive moves problem to archive/, updates config.json, handles current_problem reassignment
6. All 7 files follow established command/agent patterns from Phase 1
</verification>

<success_criteria>
- All Phase 1 commands updated with path resolution through config.json (no more .math/FILENAME.md hardcoded paths)
- /math:switch enables multi-problem workspace navigation per user decision
- /math:archive implements explicit archiving per user decision
- Migration path from Phase 1 flat layout to Phase 2 per-problem directories exists in /math:init
- /math:init creates JOURNAL.md alongside PROBLEM.md, NOTATION.md, STATE.md for each new problem
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-state-research-journal/02-02-SUMMARY.md`
</output>
